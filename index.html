<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), camera=(), microphone=()">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="Referrer-Policy" content="no-referrer">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests">
  <title>Status Page - BTG Pactual</title>
  
  
  <meta name="description" content="Status em tempo real dos sistemas BTG Pactual.">
  <meta property="og:title" content="BTG Pactual Status">
  <meta property="og:type" content="website">
  <meta name="theme-color" content="#0b1220">
  <link rel="manifest" href="/manifest.webmanifest">
<!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide Icons -->
  <script defer src="https://unpkg.com/lucide@latest"></script>
  
  <!-- VanillaTilt -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"></script>
  
  <!-- GSAP -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    }
  </script>
  
  <style>
    :root {
      /* Light theme */
      --bg: 240 20% 98%;
      --panel: 0 0% 100%;
      --ink: 222 47% 11%;
      --ink-muted: 215 16% 47%;
      --primary: 217 91% 60%;
      --ok: 142 71% 45%;
      --warn: 38 92% 50%;
      --err: 0 84% 60%;
      --info: 199 89% 48%;
      --maint: 240 5% 65%;
      --bd: 214 32% 91%;
    }
    
    [data-theme="dark"] {
      --bg: 222 47% 11%;
      --panel: 217 33% 17%;
      --ink: 210 40% 98%;
      --ink-muted: 215 20% 65%;
      --primary: 217 91% 60%;
      --ok: 142 71% 45%;
      --warn: 38 92% 50%;
      --err: 0 84% 60%;
      --info: 199 89% 48%;
      --maint: 240 5% 65%;
      --bd: 217 33% 25%;
    }
    
    /* Colorblind mode */
    body.cb {
      --ok: 201 79% 46%;
      --warn: 38 92% 50%;
      --err: 0 0% 30%;
    }
    
    /* High contrast mode */
    body.hc {
      --bg: 0 0% 0%;
      --panel: 0 0% 10%;
      --ink: 0 0% 100%;
      --bd: 0 0% 50%;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      background: hsl(var(--bg));
      color: hsl(var(--ink));
      overflow-x: hidden;
    }
    
    .glass {
      background: color-mix(in srgb, hsl(var(--panel)) 80%, transparent);
      backdrop-filter: blur(12px);
      border: 1px solid hsl(var(--bd));
      border-radius: 16px;
    }
    
    .glass-strong {
      background: hsl(var(--panel));
      border: 1px solid hsl(var(--bd));
      border-radius: 16px;
    }
    
    .lift {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .status-ok { background: hsl(var(--ok)); }
    .status-info { background: hsl(var(--info)); }
    .status-warn { background: hsl(var(--warn)); }
    .status-err { background: hsl(var(--err)); }
    .status-maint { background: hsl(var(--maint)); }
    
    .ticker {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
    }
    
    .ticker-content {
      display: inline-flex;
      gap: 2rem;
      animation: scroll 30s linear infinite;
    }
    
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    
    @media (prefers-reduced-motion: reduce) {
      .ticker-content {
        animation: none;
      }
      .lift {
        transition: none;
      }
    }
    
    .ring {
      position: relative;
      width: 80px;
      height: 80px;
    }
    
    .ring svg {
      transform: rotate(-90deg);
    }
    
    .ring-bg {
      fill: none;
      stroke: hsl(var(--bd));
      stroke-width: 8;
    }
    
    .ring-fg {
      fill: none;
      stroke: hsl(var(--primary));
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    
    .meter {
      height: 8px;
      background: hsl(var(--bd));
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    
    .meter-fill {
      height: 100%;
      background: hsl(var(--primary));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .uptime-bar {
      height: 32px;
      border-radius: 4px;
      border: 1px solid hsl(var(--bd));
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }
    
    .uptime-bar:hover {
      transform: scale(1.05);
      border-color: hsl(var(--primary));
    }
    
    .uptime-bar.ok { background: hsl(var(--ok)); }
    .uptime-bar.warn { background: hsl(var(--warn)); }
    .uptime-bar.err { background: hsl(var(--err)); }
    .uptime-bar.maint { background: hsl(var(--maint)); }
    
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .accordion-content.open {
      max-height: 2000px;
    }
    
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 500;
      background: color-mix(in srgb, hsl(var(--panel)) 60%, transparent);
      border: 1px solid hsl(var(--bd));
    }
    
    .badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .badge-p1 {
      background: hsl(var(--err) / 0.2);
      color: hsl(var(--err));
      border: 1px solid hsl(var(--err));
    }
    
    .badge-p2 {
      background: hsl(var(--warn) / 0.2);
      color: hsl(var(--warn));
      border: 1px solid hsl(var(--warn));
    }
    
    .badge-p3 {
      background: hsl(var(--info) / 0.2);
      color: hsl(var(--info));
      border: 1px solid hsl(var(--info));
    }
    
    #quickPopover {
      position: fixed;
      z-index: 1000;
      max-width: 400px;
      display: none;
    }
    
    #quickPopover.active {
      display: block;
    }
    
    .reveal {
      opacity: 0;
      transform: translateY(20px);
    }
    
    .revealed {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    
    #canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.3;
    }
    
    .golden-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .golden-card {
      padding: 1rem;
      border-radius: 8px;
      background: color-mix(in srgb, hsl(var(--panel)) 40%, transparent);
      border: 1px solid hsl(var(--bd));
    }
    
    .highlight-incident {
      animation: highlight 1s ease;
    }
    
    @keyframes highlight {
      0%, 100% { background: transparent; }
      50% { background: hsl(var(--primary) / 0.1); }
    }
  
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    :focus-visible { outline: 2px solid hsl(var(--primary)); outline-offset: 2px; }
</style>
</head>
<body>
  <div id="sr-live" class="sr-only" aria-live="polite"></div>
  <canvas id="canvas"></canvas>
  
  <!-- Header -->
  <header class="glass-strong sticky top-0 z-50 px-6 py-4">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center">
          <i data-lucide="activity" class="w-6 h-6 text-white"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold" data-i18n="title">Status Page BTG Pactual</h1>
          <p class="text-sm text-gray-500" id="lastUpdate" data-i18n="updated">Atualizado agora</p>
        </div>
      </div>
      
      <div class="flex items-center gap-2">
        <!-- Language Selector -->
        <select id="langSelect" class="px-3 py-2 rounded-lg glass text-sm" aria-label="Select language">
          <option value="pt">PT</option>
          <option value="en">EN</option>
          <option value="es">ES</option>
        </select>
        
        <!-- Theme Toggle -->
        <button id="themeBtn" class="p-2 rounded-lg glass hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Toggle theme" aria-pressed="false">
          <i data-lucide="moon" class="w-5 h-5"></i>
        </button>
        
        <!-- Colorblind Mode -->
        <button id="cbBtn" class="p-2 rounded-lg glass hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Toggle colorblind mode" aria-pressed="false">
          <i data-lucide="eye" class="w-5 h-5"></i>
        </button>
        
        <!-- High Contrast -->
        <button id="hcBtn" class="p-2 rounded-lg glass hover:bg-gray-200 dark:hover:bg-gray-700 transition" aria-label="Toggle high contrast" aria-pressed="false">
          <i data-lucide="contrast" class="w-5 h-5"></i>
        </button>
        
        <!-- Live/Pause -->
        <button id="liveBtn" aria-pressed="true" class="px-3 py-2 rounded-lg glass hover:bg-gray-200 dark:hover:bg-gray-700 transition text-sm font-medium" aria-label="Toggle live updates">
          <span data-i18n="live">Live</span>
        </button>
      </div>
    </div>
  </header>
  
  <!-- Office Clocks Ticker -->
  <div class="glass-strong py-3 px-6 sticky top-[76px] z-40">
    <div class="ticker">
      <div id="clockTicker" class="ticker-content"></div>
    </div>
  </div>
  
  <!-- System Status Ticker -->
  <div class="glass py-3 px-6 sticky top-[124px] z-30">
    <div class="ticker">
      <div id="statusTicker" class="ticker-content"></div>
    </div>
  </div>
  
  <main class="max-w-7xl mx-auto px-6 py-8 space-y-8">
    <!-- KPIs -->
    <section class="reveal">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
          <span data-i18n="kpi.title">KPIs de Performance</span>
        </h2>
        <button class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" data-guide="kpi">
          <i data-lucide="help-circle" class="w-4 h-4 inline"></i>
          <span data-i18n="quickGuide">Guia rápido</span>
        </button>
      </div>
      <div id="kpiGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
    </section>
    
    <!-- Timeline -->
    <section class="reveal">
      <div class="glass p-6">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <i data-lucide="calendar" class="w-6 h-6"></i>
          <span data-i18n="timeline.title">Linha do Tempo de Uptime</span>
        </h2>
        <div class="space-y-4">
          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium" data-i18n="timeline.7d">Últimos 7 dias</span>
              <span class="text-sm text-gray-500" id="uptime7d">99.9%</span>
            </div>
            <div id="timeline7d" class="flex gap-1"></div>
          </div>
          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium" data-i18n="timeline.30d">Últimos 30 dias</span>
              <span class="text-sm text-gray-500" id="uptime30d">99.8%</span>
            </div>
            <div id="timeline30d" class="flex gap-1"></div>
          </div>
          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium" data-i18n="timeline.90d">Últimos 90 dias</span>
              <span class="text-sm text-gray-500" id="uptime90d">99.7%</span>
            </div>
            <div id="timeline90d" class="flex gap-1"></div>
          </div>
        </div>
        
        <!-- Legend -->
        <div class="mt-4 flex flex-wrap gap-4 text-sm">
          <div class="flex items-center gap-2">
            <div class="status-dot status-ok"></div>
            <span data-i18n="legend.ok">Operacional</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="status-dot status-warn"></div>
            <span data-i18n="legend.warn">Degradado</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="status-dot status-err"></div>
            <span data-i18n="legend.err">Indisponível</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="status-dot status-maint"></div>
            <span data-i18n="legend.maint">Manutenção</span>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Global Filters -->
    <section class="reveal">
      <div class="glass p-6">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <i data-lucide="filter" class="w-6 h-6"></i>
          <span data-i18n="filters.title">Filtros Globais</span>
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-2" data-i18n="filters.severity">Severidade</label>
            <select id="sevFilter" class="w-full px-3 py-2 rounded-lg glass">
              <option value="" data-i18n="filters.all">Todos</option>
              <option value="err" data-i18n="filters.critical">Crítico</option>
              <option value="warn" data-i18n="filters.warning">Aviso</option>
              <option value="info" data-i18n="filters.info">Info</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2" data-i18n="filters.component">Componente</label>
            <select id="compFilter" class="w-full px-3 py-2 rounded-lg glass">
              <option value="" data-i18n="filters.all">Todos</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2" data-i18n="filters.search">Busca</label>
            <input type="text" id="searchInput" class="w-full px-3 py-2 rounded-lg glass" placeholder="Buscar sistemas...">
          </div>
        </div>
      </div>
    </section>
    
    <!-- Systems -->
    <section class="reveal">
      <div class="glass p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold flex items-center gap-2">
            <i data-lucide="server" class="w-6 h-6"></i>
            <span data-i18n="systems.title">Sistemas</span>
          </h2>
          <div class="flex gap-2">
            <button id="expandAll" class="text-sm px-3 py-1 rounded-lg glass hover:bg-gray-200 dark:hover:bg-gray-700" data-i18n="systems.expandAll">Expandir tudo</button>
            <button id="collapseAll" class="text-sm px-3 py-1 rounded-lg glass hover:bg-gray-200 dark:hover:bg-gray-700" data-i18n="systems.collapseAll">Recolher tudo</button>
            <button class="text-sm text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" data-guide="systems">
              <i data-lucide="help-circle" class="w-4 h-4 inline"></i>
              <span data-i18n="quickGuide">Guia rápido</span>
            </button>
          </div>
        </div>
        <div id="systemsAccordion" class="space-y-4"></div>
      </div>
    </section>
    
    <!-- Recent Incidents -->
    <section class="reveal">
      <div class="glass p-6">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <i data-lucide="alert-triangle" class="w-6 h-6"></i>
          <span data-i18n="incidents.title">Incidentes Recentes</span>
        </h2>
        <div id="incidentsList" class="space-y-4"></div>
      </div>
    </section>
    
    <!-- Maintenance -->
    <section class="reveal">
      <div class="glass p-6">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <i data-lucide="wrench" class="w-6 h-6"></i>
          <span data-i18n="maint.title">Manutenções Programadas</span>
        </h2>
        <div id="maintList" class="space-y-4"></div>
      </div>
    </section>
    
    <!-- Subscriptions & Integrations -->
    <section class="reveal">
      <div class="glass p-6">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
          <i data-lucide="bell" class="w-6 h-6"></i>
          <span data-i18n="subscribe.title">Assinaturas & Integrações</span>
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-semibold mb-2" data-i18n="subscribe.email">Assinar por E-mail</h3>
            <form id="subscribeForm" class="flex gap-2">
              <input type="email" placeholder="seu@email.com" class="flex-1 px-3 py-2 rounded-lg glass" required>
              <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition" data-i18n="subscribe.submit">Assinar</button>
            </form>
            <div class="mt-2">
              <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" class="rounded">
                <span data-i18n="subscribe.webhook">Incluir webhook (opcional)</span>
              </label>
            </div>
          </div>
          <div>
            <h3 class="font-semibold mb-2" data-i18n="subscribe.integrations">Integrações</h3>
            <div class="flex flex-wrap gap-2">
              <a href="#" class="chip hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <i data-lucide="rss" class="w-4 h-4"></i>
                <span>RSS</span>
              </a>
              <a href="#" class="chip hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <i data-lucide="code" class="w-4 h-4"></i>
                <span>API</span>
              </a>
              <a href="#" class="chip hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <i data-lucide="file-text" class="w-4 h-4"></i>
                <span>Changelog</span>
              </a>
              <a href="#" class="chip hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                <i data-lucide="help-circle" class="w-4 h-4"></i>
                <span data-i18n="subscribe.support">Suporte</span>
              </a>
            </div>
            <div class="mt-4">
              <span class="text-sm text-gray-500">Tests: <span id="testStatus" class="font-medium text-green-500">OK</span></span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  
  <footer class="text-center py-8 text-sm text-gray-500">
    <p data-i18n="footer">Demonstração. Dados sintéticos. Fuso configurável. BTG Pactual.</p>
  </footer>
  
  <!-- Quick Guide Popover -->
  <div id="quickPopover" class="glass-strong p-4 shadow-lg">
    <div class="flex items-center justify-between mb-2">
      <h3 class="font-semibold" id="popoverTitle">Guia Rápido</h3>
      <button id="closePopover" class="text-gray-500 hover:text-gray-700">
        <i data-lucide="x" class="w-4 h-4"></i>
      </button>
    </div>
    <div id="popoverContent" class="text-sm text-gray-600 dark:text-gray-400"></div>
  </div>
  
  <script>
    
    // Icons helper to mark decorative SVGs
    function createIconsSafe(){
      lucide.createIcons();
      document.querySelectorAll('svg.lucide').forEach(svg => {
        if (!svg.hasAttribute('aria-label')) {
          svg.setAttribute('aria-hidden','true');
          svg.setAttribute('focusable','false');
        }
      });
    }
    // ============= I18N =============
    
    const i18n = {
      pt: {
        title: 'Status Page BTG Pactual',
        updated: 'Atualizado agora',
        live: 'Live',
        pause: 'Pausar',
        quickGuide: 'Guia rápido',
        kpi: {
          title: 'KPIs de Performance',
          uptime: 'Uptime 30d',
          p95: 'Latência p95',
          incidents: 'Incidentes 30d',
          mttr: 'MTTR',
          mtbf: 'MTBF',
          error: 'Taxa de Erro',
          sla: 'SLA',
          budget: 'SLO Budget'
        },
        timeline: {
          title: 'Linha do Tempo de Uptime',
          '7d': 'Últimos 7 dias',
          '30d': 'Últimos 30 dias',
          '90d': 'Últimos 90 dias'
        },
        legend: {
          ok: 'Operacional',
          warn: 'Degradado',
          err: 'Indisponível',
          info: 'Informação',
          maint: 'Manutenção'
        },
        filters: {
          title: 'Filtros Globais',
          severity: 'Severidade',
          component: 'Componente',
          search: 'Busca',
          all: 'Todos',
          critical: 'Crítico',
          warning: 'Aviso',
          info: 'Info'
        },
        systems: {
          title: 'Sistemas',
          expandAll: 'Expandir tudo',
          collapseAll: 'Recolher tudo',
          system: 'Sistema',
          status: 'Status',
          lastIncident: 'Último Incidente',
          notes: 'Observações',
          subsystems: 'Subsistemas',
          goldenSignals: '4 Golden Signals'
        },
        incidents: {
          title: 'Incidentes Recentes',
          duration: 'Duração',
          components: 'Componentes',
          timeline: 'Linha do Tempo',
          postmortem: 'Post Mortem',
          ongoing: 'Em andamento'
        },
        maint: {
          title: 'Manutenções Programadas',
          start: 'Início',
          end: 'Fim',
          duration: 'Duração',
          impact: 'Impacto',
          owner: 'Responsável',
          notes: 'Notas'
        },
        subscribe: {
          title: 'Assinaturas & Integrações',
          email: 'Assinar por E-mail',
          submit: 'Assinar',
          webhook: 'Incluir webhook (opcional)',
          integrations: 'Integrações',
          support: 'Suporte'
        },
        footer: 'Demonstração. Dados sintéticos. Fuso configurável. BTG Pactual.',
        golden: {
          latency: 'Latência p95',
          traffic: 'Tráfego',
          errors: 'Erros',
          saturation: 'Saturação'
        }
      },
      en: {
        title: 'BTG Pactual Status Page',
        updated: 'Updated now',
        live: 'Live',
        pause: 'Pause',
        quickGuide: 'Quick guide',
        kpi: {
          title: 'Performance KPIs',
          uptime: '30d Uptime',
          p95: 'p95 Latency',
          incidents: '30d Incidents',
          mttr: 'MTTR',
          mtbf: 'MTBF',
          error: 'Error Rate',
          sla: 'SLA',
          budget: 'SLO Budget'
        },
        timeline: {
          title: 'Uptime Timeline',
          '7d': 'Last 7 days',
          '30d': 'Last 30 days',
          '90d': 'Last 90 days'
        },
        legend: {
          ok: 'Operational',
          warn: 'Degraded',
          err: 'Unavailable',
          info: 'Information',
          maint: 'Maintenance'
        },
        filters: {
          title: 'Global Filters',
          severity: 'Severity',
          component: 'Component',
          search: 'Search',
          all: 'All',
          critical: 'Critical',
          warning: 'Warning',
          info: 'Info'
        },
        systems: {
          title: 'Systems',
          expandAll: 'Expand all',
          collapseAll: 'Collapse all',
          system: 'System',
          status: 'Status',
          lastIncident: 'Last Incident',
          notes: 'Notes',
          subsystems: 'Subsystems',
          goldenSignals: '4 Golden Signals'
        },
        incidents: {
          title: 'Recent Incidents',
          duration: 'Duration',
          components: 'Components',
          timeline: 'Timeline',
          postmortem: 'Post Mortem',
          ongoing: 'Ongoing'
        },
        maint: {
          title: 'Scheduled Maintenance',
          start: 'Start',
          end: 'End',
          duration: 'Duration',
          impact: 'Impact',
          owner: 'Owner',
          notes: 'Notes'
        },
        subscribe: {
          title: 'Subscriptions & Integrations',
          email: 'Subscribe via Email',
          submit: 'Subscribe',
          webhook: 'Include webhook (optional)',
          integrations: 'Integrations',
          support: 'Support'
        },
        footer: 'Demo. Synthetic data. Configurable timezone. BTG Pactual.',
        golden: {
          latency: 'p95 Latency',
          traffic: 'Traffic',
          errors: 'Errors',
          saturation: 'Saturation'
        }
      },
      es: {
        title: 'Página de Estado BTG Pactual',
        updated: 'Actualizado ahora',
        live: 'En vivo',
        pause: 'Pausar',
        quickGuide: 'Guía rápida',
        kpi: {
          title: 'KPIs de Rendimiento',
          uptime: 'Uptime 30d',
          p95: 'Latencia p95',
          incidents: 'Incidentes 30d',
          mttr: 'MTTR',
          mtbf: 'MTBF',
          error: 'Tasa de Error',
          sla: 'SLA',
          budget: 'Presupuesto SLO'
        },
        timeline: {
          title: 'Línea de Tiempo de Uptime',
          '7d': 'Últimos 7 días',
          '30d': 'Últimos 30 días',
          '90d': 'Últimos 90 días'
        },
        legend: {
          ok: 'Operacional',
          warn: 'Degradado',
          err: 'No disponible',
          info: 'Información',
          maint: 'Mantenimiento'
        },
        filters: {
          title: 'Filtros Globales',
          severity: 'Severidad',
          component: 'Componente',
          search: 'Búsqueda',
          all: 'Todos',
          critical: 'Crítico',
          warning: 'Advertencia',
          info: 'Info'
        },
        systems: {
          title: 'Sistemas',
          expandAll: 'Expandir todo',
          collapseAll: 'Contraer todo',
          system: 'Sistema',
          status: 'Estado',
          lastIncident: 'Último Incidente',
          notes: 'Notas',
          subsystems: 'Subsistemas',
          goldenSignals: '4 Señales Doradas'
        },
        incidents: {
          title: 'Incidentes Recientes',
          duration: 'Duración',
          components: 'Componentes',
          timeline: 'Línea de Tiempo',
          postmortem: 'Post Mortem',
          ongoing: 'En curso'
        },
        maint: {
          title: 'Mantenimiento Programado',
          start: 'Inicio',
          end: 'Fin',
          duration: 'Duración',
          impact: 'Impacto',
          owner: 'Responsable',
          notes: 'Notas'
        },
        subscribe: {
          title: 'Suscripciones e Integraciones',
          email: 'Suscribirse por correo',
          submit: 'Suscribirse',
          webhook: 'Incluir webhook (opcional)',
          integrations: 'Integraciones',
          support: 'Soporte'
        },
        footer: 'Demostración. Datos sintéticos. Zona horaria configurable. BTG Pactual.',
        golden: {
          latency: 'Latencia p95',
          traffic: 'Tráfico',
          errors: 'Errores',
          saturation: 'Saturación'
        }
      }
    };
    
    // ============= DATA =============
    const offices = [
      { city: 'São Paulo', tz: 'America/Sao_Paulo' },
      { city: 'New York', tz: 'America/New_York' },
      { city: 'London', tz: 'Europe/London' },
      { city: 'Hong Kong', tz: 'Asia/Hong_Kong' },
      { city: 'Tokyo', tz: 'Asia/Tokyo' }
    ];
    
    const categories = [
      {
        id: 'trading',
        name: { pt: 'Trading', en: 'Trading', es: 'Trading' },
        systems: [
          {
            id: 'fix-gateway',
            name: { pt: 'FIX Gateway', en: 'FIX Gateway', es: 'FIX Gateway' },
            status: 'ok',
            last: '2025-10-28',
            notes: { pt: 'Sistema crítico', en: 'Critical system', es: 'Sistema crítico' },
            subs: [
              { name: 'FIX 4.2', status: 'ok' },
              { name: 'FIX 4.4', status: 'ok' },
              { name: 'FIXT 1.1', status: 'warn' }
            ]
          },
          {
            id: 'order-mgmt',
            name: { pt: 'Order Management', en: 'Order Management', es: 'Gestión de Órdenes' },
            status: 'ok',
            last: '2025-10-25',
            notes: { pt: 'Alta disponibilidade', en: 'High availability', es: 'Alta disponibilidad' },
            subs: [
              { name: 'OMS Core', status: 'ok' },
              { name: 'Risk Engine', status: 'ok' },
              { name: 'Execution Gateway', status: 'ok' }
            ]
          }
        ]
      },
      {
        id: 'market-data',
        name: { pt: 'Market Data', en: 'Market Data', es: 'Datos de Mercado' },
        systems: [
          {
            id: 'reuters',
            name: { pt: 'Reuters Feed', en: 'Reuters Feed', es: 'Reuters Feed' },
            status: 'ok',
            last: '2025-10-20',
            notes: { pt: 'Redundante', en: 'Redundant', es: 'Redundante' },
            subs: [
              { name: 'RMDS Primary', status: 'ok' },
              { name: 'RMDS Backup', status: 'ok' }
            ]
          },
          {
            id: 'bloomberg',
            name: { pt: 'Bloomberg Feed', en: 'Bloomberg Feed', es: 'Bloomberg Feed' },
            status: 'warn',
            last: '2025-10-30',
            notes: { pt: 'Latência elevada', en: 'High latency', es: 'Alta latencia' },
            subs: [
              { name: 'B-PIPE', status: 'warn' },
              { name: 'SAPI', status: 'ok' }
            ]
          }
        ]
      },
      {
        id: 'infra',
        name: { pt: 'Infraestrutura', en: 'Infrastructure', es: 'Infraestructura' },
        systems: [
          {
            id: 'auth',
            name: { pt: 'Autenticação', en: 'Authentication', es: 'Autenticación' },
            status: 'ok',
            last: '2025-09-15',
            notes: { pt: 'SSO ativo', en: 'SSO active', es: 'SSO activo' },
            subs: [
              { name: 'LDAP', status: 'ok' },
              { name: 'SAML', status: 'ok' },
              { name: 'OAuth', status: 'ok' }
            ]
          },
          {
            id: 'monitoring',
            name: { pt: 'Monitoramento', en: 'Monitoring', es: 'Monitoreo' },
            status: 'ok',
            last: '2025-10-01',
            notes: { pt: 'Dashboards atualizados', en: 'Updated dashboards', es: 'Dashboards actualizados' },
            subs: [
              { name: 'Prometheus', status: 'ok' },
              { name: 'Grafana', status: 'ok' },
              { name: 'Alertmanager', status: 'ok' }
            ]
          }
        ]
      }
    ];
    
    
    // Time helpers
    const dt = (s) => new Date(/Z$/.test(s) ? s : s + 'Z');
const incidents = [
      {
        id: 'inc-001',
        sev: 'err',
        title: { pt: 'Falha no FIX Gateway', en: 'FIX Gateway Failure', es: 'Falla en FIX Gateway' },
        comp: ['fix-gateway'],
        start: dt('2025-10-30T14:23:00'),
        end: dt('2025-10-30T15:45:00'),
        updates: [
          { t: dt('2025-10-30T14:23:00'), m: { pt: 'Incidente identificado', en: 'Incident identified', es: 'Incidente identificado' } },
          { t: dt('2025-10-30T14:45:00'), m: { pt: 'Equipe investigando', en: 'Team investigating', es: 'Equipo investigando' } },
          { t: dt('2025-10-30T15:30:00'), m: { pt: 'Correção aplicada', en: 'Fix applied', es: 'Corrección aplicada' } },
          { t: dt('2025-10-30T15:45:00'), m: { pt: 'Sistema restaurado', en: 'System restored', es: 'Sistema restaurado' } }
        ]
      },
      {
        id: 'inc-002',
        sev: 'warn',
        title: { pt: 'Latência elevada no Bloomberg', en: 'High latency on Bloomberg', es: 'Alta latencia en Bloomberg' },
        comp: ['bloomberg'],
        start: dt('2025-10-30T09:00:00'),
        end: null,
        updates: [
          { t: dt('2025-10-30T09:00:00'), m: { pt: 'Latência detectada', en: 'Latency detected', es: 'Latencia detectada' } },
          { t: dt('2025-10-30T10:15:00'), m: { pt: 'Investigação em andamento', en: 'Investigation ongoing', es: 'Investigación en curso' } }
        ]
      },
      {
        id: 'inc-003',
        sev: 'info',
        title: { pt: 'Manutenção de rotina concluída', en: 'Routine maintenance completed', es: 'Mantenimiento de rutina completado' },
        comp: ['auth'],
        start: dt('2025-10-28T02:00:00'),
        end: dt('2025-10-28T04:00:00'),
        updates: [
          { t: dt('2025-10-28T02:00:00'), m: { pt: 'Início da manutenção', en: 'Maintenance started', es: 'Inicio del mantenimiento' } },
          { t: dt('2025-10-28T04:00:00'), m: { pt: 'Manutenção concluída', en: 'Maintenance completed', es: 'Mantenimiento completado' } }
        ]
      }
    ];
    
    const maints = [
      {
        start: dt('2025-11-05T02:00:00'),
        end: dt('2025-11-05T06:00:00'),
        impact: { pt: 'Baixo', en: 'Low', es: 'Bajo' },
        comp: ['monitoring'],
        owner: 'DevOps Team',
        notes: { pt: 'Atualização de segurança', en: 'Security update', es: 'Actualización de seguridad' }
      },
      {
        when: dt('2025-11-10T22:00:00'),
        etaMinutes: 180,
        impact: { pt: 'Médio', en: 'Medium', es: 'Medio' },
        comp: ['order-mgmt', 'fix-gateway'],
        owner: 'Trading Team',
        notes: { pt: 'Upgrade de versão', en: 'Version upgrade', es: 'Actualización de versión' }
      }
    ];
    
    const kpi = {
      uptime: 99.87,
      p95: 45,
      err: 0.02,
      inc7: 3,
      mttr: 42,
      mtbf: 720,
      sla: 99.9,
      budget: 92.5
    };
    
    // ============= STATE =============
    let currentLang = localStorage.getItem('lang') || 'pt';
    let isLive = true;
    let timers = [];
    
    // ============= HELPERS =============
    function t(key) {
      const keys = key.split('.');
      let obj = i18n[currentLang];
      for (const k of keys) {
        obj = obj[k];
        if (!obj) return key;
      }
      return obj;
    }
    
    function updateI18n() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });
      
      // Update placeholders
      document.querySelector('#searchInput').placeholder = t('filters.search') + '...';
    }
    
    function formatDate(date, locale = 'pt-BR') {
      return new Intl.DateTimeFormat(locale, {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }).format(date);
    }
    
    function formatDuration(ms) {
      const mins = Math.floor(ms / 60000);
      const hrs = Math.floor(mins / 60);
      if (hrs > 0) return `${hrs}h ${mins % 60}m`;
      return `${mins}m`;
    }
    
    function calcDuration(start, end) {
      if (!end) {
        return Date.now() - start.getTime();
      }
      return end.getTime() - start.getTime();
    }
    
    function getStatusClass(status) {
      return `status-${status}`;
    }
    
    function getPriority(incident) {
      if (incident.sev === 'err') return 'P1';
      if (incident.sev === 'warn') return 'P2';
      return 'P3';
    }
    
    function genMetrics(sysId, subName) {
      const seed = (sysId + subName).split('').reduce((a, b) => a + b.charCodeAt(0), 0);
      return {
        latency: 20 + (seed % 80),
        traffic: 100 + (seed % 900),
        errors: (seed % 10) / 10,
        saturation: 30 + (seed % 60)
      };
    }
    
    // ============= RENDER FUNCTIONS =============
    function renderClockTicker() {
      const ticker = document.getElementById('clockTicker');
      const now = new Date();
      const brtOffset = now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo', hour12: false });
      
      let html = '';
      offices.forEach(office => {
        const time = now.toLocaleString('en-US', { 
          timeZone: office.tz, 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false 
        });
        const diff = calculateTimeDiff(office.tz);
        html += `
          <div class="flex items-center gap-2">
            <i data-lucide="clock" class="w-4 h-4"></i>
            <span class="font-medium">${office.city}</span>
            <span class="text-gray-500">${time}</span>
            <span class="text-xs text-gray-400">(${diff})</span>
          </div>
        `;
      });
      
      // Duplicate for seamless loop
      ticker.innerHTML = html + html;
      createIconsSafe();
    }
    
    function calculateTimeDiff(tz) {
      const now = new Date();
      const brt = new Date(now.toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
      const local = new Date(now.toLocaleString('en-US', { timeZone: tz }));
      const diff = (local - brt) / 3600000;
      if (diff === 0) return 'BRT';
      return diff > 0 ? `+${diff}h` : `${diff}h`;
    }
    
    function renderStatusTicker() {
      const ticker = document.getElementById('statusTicker');
      let html = '';
      
      categories.forEach(cat => {
        cat.systems.forEach(sys => {
          const sysName = sys.name[currentLang];
          html += `
            <div class="chip">
              <span class="status-dot ${getStatusClass(sys.status)}"></span>
              <span>${sysName}</span>
              <span class="text-xs text-gray-400">${t('legend.' + sys.status)}</span>
            </div>
          `;
        });
      });
      
      ticker.innerHTML = html + html;
    }
    
    function renderKPIs() {
      const grid = document.getElementById('kpiGrid');
      const kpis = [
        { key: 'uptime', value: kpi.uptime, unit: '%', icon: 'trending-up', color: 'ok' },
        { key: 'p95', value: kpi.p95, unit: 'ms', icon: 'zap', color: 'info' },
        { key: 'incidents', value: kpi.inc7, unit: '', icon: 'alert-circle', color: 'warn' },
        { key: 'mttr', value: kpi.mttr, unit: 'min', icon: 'clock', color: 'primary' },
        { key: 'mtbf', value: kpi.mtbf, unit: 'h', icon: 'activity', color: 'ok' },
        { key: 'error', value: kpi.err, unit: '%', icon: 'x-circle', color: 'err' },
        { key: 'sla', value: kpi.sla, unit: '%', icon: 'target', color: 'ok' },
        { key: 'budget', value: kpi.budget, unit: '%', icon: 'pie-chart', color: 'info', ring: true }
      ];
      
      grid.innerHTML = kpis.map(k => {
        if (k.ring) {
          const circumference = 2 * Math.PI * 36;
          const offset = circumference - (k.value / 100) * circumference;
          return `
            <div class="glass lift p-6">
              <div class="flex items-start justify-between mb-4">
                <div>
                  <div class="text-sm text-gray-500 mb-1">${t('kpi.' + k.key)}</div>
                  <div class="text-2xl font-bold">${k.value}${k.unit}</div>
                </div>
                <div class="ring">
                  <svg width="80" height="80">
                    <circle class="ring-bg" cx="40" cy="40" r="36"></circle>
                    <circle class="ring-fg" cx="40" cy="40" r="36" 
                      stroke-dasharray="${circumference}" 
                      stroke-dashoffset="${offset}"></circle>
                  </svg>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <i data-lucide="${k.icon}" class="w-6 h-6"></i>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        return `
          <div class="glass lift p-6">
            <div class="flex items-center justify-between mb-2">
              <i data-lucide="${k.icon}" class="w-5 h-5 status-${k.color}"></i>
            </div>
            <div class="text-sm text-gray-500 mb-1">${t('kpi.' + k.key)}</div>
            <div class="text-2xl font-bold mb-2">${k.value}${k.unit}</div>
            <div class="meter">
              <div class="meter-fill status-${k.color}" style="width: ${Math.min(k.value, 100)}%"></div>
            </div>
          </div>
        `;
      }).join('');
      
      createIconsSafe();
    }
    
    
    function dailyStatus(date) {
      const start = new Date(date);
      start.setHours(0,0,0,0);
      const end = new Date(start);
      end.setHours(23,59,59,999);
      let downMs = 0;
      incidents.forEach(inc => {
        const a = inc.start ? new Date(inc.start) : null;
        const b = inc.end ? new Date(inc.end) : new Date();
        if (!a || inc.sev !== 'err') return;
        const overlap = Math.max(0, Math.min(end, b) - Math.max(start, a));
        downMs += overlap;
      });
      const total = end - start;
      const pct = 100 * (1 - (downMs / total));
      let status = 'ok';
      if (pct < 99.0) status = 'err';
      else if (pct < 99.9) status = 'warn';
      return { pct, status };
    }

function renderTimeline(days, containerId, uptimeId) {
  const container = document.getElementById(containerId);
  const now = new Date();
  const bars = [];
  let okCount = 0;
  for (let i = days - 1; i >= 0; i--) {
    const date = new Date(now);
    date.setDate(date.getDate() - i);
    const { pct, status } = dailyStatus(date);
    if (status === 'ok') okCount++;
    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
    bars.push({
      date: date.toISOString().split('T')[0],
      status,
      isWeekend,
      width: `${100 / days}%`,
      pct
    });
  }
  container.innerHTML = bars.map(b => `
    <div class="uptime-bar ${b.status} ${b.isWeekend ? 'opacity-60' : ''}" 
         title="${b.date} • ${b.pct.toFixed(3)}%" style="width: ${b.width}"></div>
  `).join('');
  const uptime = (okCount / days) * 100;
  document.getElementById(uptimeId).textContent = uptime.toFixed(1) + '%';
  // Add click handlers
  container.querySelectorAll('.uptime-bar').forEach(bar => {
    bar.addEventListener('click', () => highlightIncidents(bar.getAttribute('title').split(' • ')[0]));
  });
}

        });
        
        if (status === 'ok') okCount++;
        
        const isWeekend = date.getDay() === 0 || date.getDay() === 6;
        bars.push({
          date: date.toISOString().split('T')[0],
          status,
          isWeekend,
          width: `${100 / days}%`
        });
      }
      
      container.innerHTML = bars.map(b => `
        <div class="uptime-bar ${b.status} ${b.isWeekend ? 'opacity-60' : ''}" 
          style="width: ${b.width}" 
          data-date="${b.date}"
          title="${b.date}: ${t('legend.' + b.status)}"
          aria-label="${b.date}: ${t('legend.' + b.status)}">
        </div>
      `).join('');
      
      // Update uptime percentage
      const uptime = ((okCount / days) * 100).toFixed(2);
      document.getElementById(uptimeId).textContent = `${uptime}%`;
      
      // Add click handlers
      container.querySelectorAll('.uptime-bar').forEach(bar => {
        bar.addEventListener('click', (e) => {
          const date = e.target.getAttribute('data-date');
          const status = e.target.classList.contains('err') || e.target.classList.contains('warn');
          if (status) {
            scrollToIncidents(date);
          }
        });
      });
    }
    
    function scrollToIncidents(date) {
      const incidentsList = document.getElementById('incidentsList');
      incidentsList.scrollIntoView({ behavior: 'smooth' });
      
      // Highlight incidents from that day
      const cards = incidentsList.querySelectorAll('.incident-card');
      cards.forEach(card => {
        const cardDate = card.getAttribute('data-date');
        if (cardDate === date) {
          card.classList.add('highlight-incident');
          setTimeout(() => card.classList.remove('highlight-incident'), 2000);
        }
      });
    }
    
    function renderSystems() {
      const accordion = document.getElementById('systemsAccordion');
      const compFilter = document.getElementById('compFilter');
      
      // Populate component filter
      let allComps = new Set();
      categories.forEach(cat => {
        cat.systems.forEach(sys => {
          allComps.add(sys.id);
        });
      });
      
      compFilter.innerHTML = `<option value="">${t('filters.all')}</option>` + 
        Array.from(allComps).map(id => {
          const sys = categories.flatMap(c => c.systems).find(s => s.id === id);
          return `<option value="${id}">${sys.name[currentLang]}</option>`;
        }).join('');
      
      // Render accordion
      accordion.innerHTML = categories.map(cat => {
        const count = cat.systems.length;
        return `
          <div class="glass-strong">
            <button id="hdr-${cat.id}" class="accordion-header w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 dark:hover:bg-gray-800 transition" 
               aria-expanded="false" aria-controls="cat-${cat.id}">
              <div class="flex items-center gap-3">
                <i data-lucide="folder" class="w-5 h-5"></i>
                <span class="font-semibold text-lg">${cat.name[currentLang]}</span>
                <span class="text-sm text-gray-500">(${count})</span>
              </div>
              <i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
            </button>
            <div id="cat-${cat.id}" class="accordion-content" role="region" aria-labelledby="hdr-${cat.id}">
              <div class="px-6 pb-4">
                <table class="w-full"><caption class="sr-only">Status dos sistemas</caption>
                  <thead>
                    <tr class="border-b border-gray-200 dark:border-gray-700">
                      <th scope="col" class="text-left py-2 text-sm font-medium text-gray-500">${t('systems.system')}</th>
                      <th scope="col" class="text-left py-2 text-sm font-medium text-gray-500">${t('systems.status')}</th>
                      <th scope="col" class="text-left py-2 text-sm font-medium text-gray-500">${t('systems.lastIncident')}</th>
                      <th scope="col" class="text-left py-2 text-sm font-medium text-gray-500">${t('systems.notes')}</th>
                      <th scope="col" class="w-8"></th>
                    </tr>
                  </thead>
                  <tbody>
                    ${cat.systems.map(sys => `
                      <tr class="system-row border-b border-gray-100 dark:border-gray-800" data-system="${sys.id}">
                        <th scope="row" class="py-3 font-medium">${sys.name[currentLang]}</th>
                        <td class="py-3">
                          <div class="chip ${getStatusClass(sys.status)}">
                            <span class="status-dot ${getStatusClass(sys.status)}"></span>
                            <span>${t('legend.' + sys.status)}</span>
                          </div>
                        </td>
                        <td class="py-3 text-sm text-gray-500">${sys.last}</td>
                        <td class="py-3 text-sm text-gray-500">${sys.notes[currentLang]}</td>
                        <td class="py-3">
                          <button class="expand-btn" aria-label="Expand system details">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                          </button>
                        </td>
                      </tr>
                      <tr class="subsystem-row hidden" data-parent="${sys.id}">
                        <td colspan="5" class="p-4 bg-gray-50 dark:bg-gray-800">
                          <div class="mb-4">
                            <h4 class="font-semibold mb-2">${t('systems.subsystems')}</h4>
                            <div class="flex flex-wrap gap-2">
                              ${sys.subs.map(sub => `
                                <button class="chip ${getStatusClass(sub.status)} hover:bg-gray-200 dark:hover:bg-gray-700 transition subsystem-chip"
                                  data-system="${sys.id}" data-sub="${sub.name}">
                                  <span class="status-dot ${getStatusClass(sub.status)}"></span>
                                  <span>${sub.name}</span>
                                </button>
                              `).join('')}
                            </div>
                          </div>
                          <div class="golden-signals-container"></div>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      createIconsSafe();
      
      // Add accordion handlers
      document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
          const content = header.nextElementSibling;
          const icon = header.querySelector('i[data-lucide="chevron-down"]');
          const isOpen = content.classList.contains('open');
          
          content.classList.toggle('open');
          icon.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
          header.setAttribute('aria-expanded', !isOpen);
        });
      });
      
      // Add expand row handlers
      document.querySelectorAll('.expand-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const row = btn.closest('tr');
          const sysId = row.getAttribute('data-system');
          const subRow = document.querySelector(`.subsystem-row[data-parent="${sysId}"]`);
          const icon = btn.querySelector('i');
          
          if (subRow.classList.contains('hidden')) {
            subRow.classList.remove('hidden');
            icon.setAttribute('data-lucide', 'chevron-down');
          } else {
            subRow.classList.add('hidden');
            icon.setAttribute('data-lucide', 'chevron-right');
          }
          createIconsSafe();
        });
      });
      
      // Add subsystem chip handlers
      document.querySelectorAll('.subsystem-chip').forEach(chip => {
        chip.addEventListener('click', (e) => {
          const sysId = chip.getAttribute('data-system');
          const subName = chip.getAttribute('data-sub');
          const container = chip.closest('.subsystem-row').querySelector('.golden-signals-container');
          
          renderGoldenSignals(sysId, subName, container);
        });
      });
    }
    
    function renderGoldenSignals(sysId, subName, container) {
      const metrics = genMetrics(sysId, subName);
      
      container.innerHTML = `
        <h4 class="font-semibold mb-2">${t('systems.goldenSignals')} - ${subName}</h4>
        <div class="golden-grid">
          <div class="golden-card">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="zap" class="w-4 h-4 text-blue-500"></i>
              <span class="text-sm font-medium">${t('golden.latency')}</span>
            </div>
            <div class="text-2xl font-bold">${metrics.latency}ms</div>
          </div>
          <div class="golden-card">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="trending-up" class="w-4 h-4 text-green-500"></i>
              <span class="text-sm font-medium">${t('golden.traffic')}</span>
            </div>
            <div class="text-2xl font-bold">${metrics.traffic} req/s</div>
          </div>
          <div class="golden-card">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="x-circle" class="w-4 h-4 text-red-500"></i>
              <span class="text-sm font-medium">${t('golden.errors')}</span>
            </div>
            <div class="text-2xl font-bold">${metrics.errors}%</div>
          </div>
          <div class="golden-card">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="cpu" class="w-4 h-4 text-orange-500"></i>
              <span class="text-sm font-medium">${t('golden.saturation')}</span>
            </div>
            <div class="text-2xl font-bold">${metrics.saturation}%</div>
          </div>
        </div>
      `;
      
      createIconsSafe();
    }
    
    function renderIncidents() {
      const list = document.getElementById('incidentsList');
      const sevFilter = document.getElementById('sevFilter').value;
      const compFilter = document.getElementById('compFilter').value;
      
      let filtered = incidents.filter(inc => {
        if (sevFilter && inc.sev !== sevFilter) return false;
        if (compFilter && !inc.comp.includes(compFilter)) return false;
        return true;
      });
      
      list.innerHTML = filtered.map(inc => {
        const priority = getPriority(inc);
        const duration = calcDuration(inc.start, inc.end);
        const durationStr = inc.end ? formatDuration(duration) : t('incidents.ongoing');
        const date = inc.start.toISOString().split('T')[0];
        
        return `
          <div class="glass lift p-6 incident-card" data-date="${date}">
            <div class="flex items-start justify-between mb-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <span class="badge badge-${priority.toLowerCase()}">${priority}</span>
                  <h3 class="font-semibold text-lg">${inc.title[currentLang]}</h3>
                </div>
                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                  <div class="flex items-center gap-1">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span>${formatDate(inc.start, currentLang === 'pt' ? 'pt-BR' : currentLang === 'es' ? 'es-ES' : 'en-US')}</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <i data-lucide="timer" class="w-4 h-4"></i>
                    <span class="duration-${inc.id}">${durationStr}</span>
                  </div>
                </div>
              </div>
              ${priority === 'P1' ? `
                <button class="px-3 py-1 rounded-lg glass hover:bg-gray-200 dark:hover:bg-gray-700 text-sm" data-guide="postmortem">
                  ${t('incidents.postmortem')}
                </button>
              ` : ''}
            </div>
            
            <div class="mb-4">
              <h4 class="text-sm font-medium mb-2">${t('incidents.components')}</h4>
              <div class="flex flex-wrap gap-2">
                ${inc.comp.map(c => {
                  const sys = categories.flatMap(cat => cat.systems).find(s => s.id === c);
                  return `<span class="chip">${sys ? sys.name[currentLang] : c}</span>`;
                }).join('')}
              </div>
            </div>
            
            <div>
              <h4 class="text-sm font-medium mb-2">${t('incidents.timeline')}</h4>
              <div class="space-y-2">
                ${inc.updates.map((upd, i) => `
                  <div class="flex gap-3">
                    <div class="w-2 h-2 rounded-full bg-blue-500 mt-2"></div>
                    <div>
                      <div class="text-xs text-gray-500">${formatDate(upd.t, currentLang === 'pt' ? 'pt-BR' : currentLang === 'es' ? 'es-ES' : 'en-US')}</div>
                      <div class="text-sm">${upd.m[currentLang]}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      createIconsSafe();
    }
    
    function renderMaintenance() {
      const list = document.getElementById('maintList');
      
      list.innerHTML = maints.map(m => {
        let start, end, duration;
        
        if (m.start && m.end) {
          start = m.start;
          end = m.end;
          duration = formatDuration(end - start);
        } else {
          start = m.when;
          end = new Date(m.when.getTime() + m.etaMinutes * 60000);
          duration = formatDuration(m.etaMinutes * 60000);
        }
        
        return `
          <div class="glass lift p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div class="text-sm text-gray-500 mb-1">${t('maint.start')}</div>
                <div class="font-medium">${formatDate(start, currentLang === 'pt' ? 'pt-BR' : currentLang === 'es' ? 'es-ES' : 'en-US')}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 mb-1">${t('maint.end')}</div>
                <div class="font-medium">${formatDate(end, currentLang === 'pt' ? 'pt-BR' : currentLang === 'es' ? 'es-ES' : 'en-US')}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 mb-1">${t('maint.duration')}</div>
                <div class="font-medium">${duration}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 mb-1">${t('maint.impact')}</div>
                <div class="font-medium">${m.impact[currentLang]}</div>
              </div>
            </div>
            
            <div class="mb-4">
              <div class="text-sm text-gray-500 mb-2">${t('incidents.components')}</div>
              <div class="flex flex-wrap gap-2">
                ${m.comp.map(c => {
                  const sys = categories.flatMap(cat => cat.systems).find(s => s.id === c);
                  return `<span class="chip">${sys ? sys.name[currentLang] : c}</span>`;
                }).join('')}
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <div class="text-sm text-gray-500 mb-1">${t('maint.owner')}</div>
                <div class="text-sm">${m.owner}</div>
              </div>
              <div>
                <div class="text-sm text-gray-500 mb-1">${t('maint.notes')}</div>
                <div class="text-sm">${m.notes[currentLang]}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      createIconsSafe();
    }
    
    // ============= LIVE UPDATES =============
    function updateLiveDurations() {
      incidents.forEach(inc => {
        if (!inc.end) {
          const duration = calcDuration(inc.start, null);
          const el = document.querySelector(`.duration-${inc.id}`);
          if (el) {
            el.textContent = formatDuration(duration);
          }
        }
      });
    }
    
    
function startLive() {
  stopLive(); // clear first
  timers.push(setTimeout(function tick(){ renderClockTicker(); timers.push(setTimeout(tick, 30000)); }, 30000));
  timers.push(setTimeout(function tick2(){ updateLiveDurations(); timers.push(setTimeout(tick2, 60000)); }, 60000));
  const btn = document.getElementById('liveBtn');
  if (btn) {
    btn.querySelector('span').textContent = t('live');
    btn.setAttribute('aria-pressed', 'true');
    btn.setAttribute('aria-label', t('pause'));
  }
}

    
    
function stopLive() {
  timers.forEach(t => clearTimeout(t));
  timers = [];
  const btn = document.getElementById('liveBtn');
  if (btn) {
    btn.querySelector('span').textContent = t('pause');
    btn.setAttribute('aria-pressed', 'false');
    btn.setAttribute('aria-label', t('live'));
  }
}

    
    // ============= POPOVERS =============
    function showPopover(trigger, title, content) {
      const popover = document.getElementById('quickPopover');
      const rect = trigger.getBoundingClientRect();
      
      document.getElementById('popoverTitle').textContent = title;
      document.getElementById('popoverContent').innerHTML = content;
      
      popover.style.left = `${rect.left}px`;
      popover.style.top = `${rect.bottom + 10}px`;
      popover.classList.add('active');
      
      createIconsSafe();
    }
    
    function hidePopover() {
      document.getElementById('quickPopover').classList.remove('active');
    }
    
    // ============= INIT =============
    function init() {
      // Set initial language
      document.getElementById('langSelect').value = currentLang;
      updateI18n();
      
      // Load theme
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
      if (theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
      
      // Load preferences
      if (localStorage.getItem('cb') === 'true') {
        document.body.classList.add('cb');
        document.getElementById('cbBtn').setAttribute('aria-pressed', 'true');
      }
      if (localStorage.getItem('hc') === 'true') {
        document.body.classList.add('hc');
        document.getElementById('hcBtn').setAttribute('aria-pressed', 'true');
      }
      
      // Render all sections
      renderClockTicker();
      renderStatusTicker();
      renderKPIs();
      renderTimeline(7, 'timeline7d', 'uptime7d');
      renderTimeline(30, 'timeline30d', 'uptime30d');
      renderTimeline(90, 'timeline90d', 'uptime90d');
      renderSystems();
      renderIncidents();
      renderMaintenance();
      
      // Start live updates
      startLive();
      
      // Setup event listeners
      document.getElementById('langSelect').addEventListener('change', (e) => {
        currentLang = e.target.value;
        localStorage.setItem('lang', currentLang);
        updateI18n();
        renderStatusTicker();
        renderKPIs();
        renderSystems();
        renderIncidents();
        renderMaintenance();
      });
      
      document.getElementById('themeBtn').addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', next);
      });
      
      document.getElementById('cbBtn').addEventListener('click', (e) => {
        document.body.classList.toggle('cb');
        const active = document.body.classList.contains('cb');
        localStorage.setItem('cb', active);
        e.currentTarget.setAttribute('aria-pressed', active);
      });
      
      document.getElementById('hcBtn').addEventListener('click', (e) => {
        document.body.classList.toggle('hc');
        const active = document.body.classList.contains('hc');
        localStorage.setItem('hc', active);
        e.currentTarget.setAttribute('aria-pressed', active);
      });
      
      document.getElementById('liveBtn').addEventListener('click', () => {
        isLive = !isLive;
        if (isLive) {
          startLive();
        } else {
          stopLive();
        }
      });
      
      document.getElementById('sevFilter').addEventListener('change', renderIncidents);
      document.getElementById('compFilter').addEventListener('change', renderIncidents);
      
      
// Debounced search with screen reader announcement
  (function(){
    const sr = document.getElementById('sr-live') || (function(){
      const d = document.createElement('div');
      d.id = 'sr-live';
      d.className = 'sr-only';
      d.setAttribute('aria-live','polite');
      document.body.appendChild(d);
      return d;
    })();
    let qT;
    document.getElementById('searchInput').addEventListener('input', (e) => {
      clearTimeout(qT);
      qT = setTimeout(() => {
        const query = e.target.value.toLowerCase();
        let shown = 0, total = 0;
        document.querySelectorAll('.system-row').forEach(row => {
          const text = row.textContent.toLowerCase();
          total++;
          const match = text.includes(query);
          row.style.display = match ? '' : 'none';
          if (match) shown++;
        });
        sr.textContent = shown + ' de ' + total + ' sistemas mostrados';
      }, 200);
    });
  })();
document.querySelectorAll('.system-row').forEach(row => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(query) ? '' : 'none';
        });
      });
      
      document.getElementById('expandAll').addEventListener('click', () => {
        document.querySelectorAll('.accordion-content').forEach(c => {c.classList.add('open'); const hdr=c.previousElementSibling; if (hdr) hdr.setAttribute('aria-expanded','true');});
        document.querySelectorAll('.accordion-header i[data-lucide="chevron-down"]').forEach(i => i.style.transform = 'rotate(180deg)');
        document.querySelectorAll('.subsystem-row').forEach(r => r.classList.remove('hidden'));
        document.querySelectorAll('.expand-btn i').forEach(i => i.setAttribute('data-lucide', 'chevron-down'));
        createIconsSafe();
      });
      
      document.getElementById('collapseAll').addEventListener('click', () => {
        document.querySelectorAll('.accordion-content').forEach(c => {c.classList.remove('open'); const hdr=c.previousElementSibling; if (hdr) hdr.setAttribute('aria-expanded','false');});
        document.querySelectorAll('.accordion-header i[data-lucide="chevron-down"]').forEach(i => i.style.transform = 'rotate(0deg)');
        document.querySelectorAll('.subsystem-row').forEach(r => r.classList.add('hidden'));
        document.querySelectorAll('.expand-btn i').forEach(i => i.setAttribute('data-lucide', 'chevron-right'));
        createIconsSafe();
      });
      
      document.getElementById('subscribeForm').addEventListener('submit', (e) => {
        e.preventDefault();
        alert('Subscription feature - demo only');
      });
      
      document.getElementById('closePopover').addEventListener('click', hidePopover);
      
      document.querySelectorAll('[data-guide]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const guide = e.currentTarget.getAttribute('data-guide');
          let content = '';
          
          if (guide === 'kpi') {
            content = '<p>KPIs show system health metrics. Higher uptime and lower error rates indicate better performance.</p>';
          } else if (guide === 'systems') {
            content = '<p><strong>4 Golden Signals:</strong><br>- Latency: Response time<br>- Traffic: Request rate<br>- Errors: Error rate<br>- Saturation: Resource usage</p>';
          } else if (guide === 'postmortem') {
            content = '<h4>Post Mortem Template</h4><p>**Root Cause:** TBD<br>**Impact:** TBD<br>**Resolution:** TBD<br>**Prevention:** TBD</p>';
          }
          
          showPopover(e.currentTarget, t('quickGuide'), content);
        });
      });
      
      // Close popover on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#quickPopover') && !e.target.closest('[data-guide]')) {
          hidePopover();
        }
      });
      
      // Close popover on resize
      window.addEventListener('resize', hidePopover);
      
      // Reveal animations
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('revealed');
          }
        });
      }, { threshold: 0.1 });
      
      document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
      
      // Initialize Lucide icons
      createIconsSafe();
      
      // Initialize VanillaTilt
      VanillaTilt.init(document.querySelectorAll('.lift'), {
        max: 5,
        speed: 400,
        glare: true,
        'max-glare': 0.1,
      });
      
      // Canvas stars
      
      // Throttled resize for canvas
      let _raf;
      function safeRAF(fn){ cancelAnimationFrame(_raf); _raf = requestAnimationFrame(fn); }
      window.addEventListener('resize', ()=> safeRAF(()=> { 
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight; 
      }));
const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      
      const stars = [];
      for (let i = 0; i < 100; i++) {
        stars.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          r: Math.random() * 1.5,
          vx: (Math.random() - 0.5) * 0.5,
          vy: (Math.random() - 0.5) * 0.5
        });
      }
      
      function animateStars() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(100, 150, 255, 0.5)';
        
        stars.forEach(s => {
          s.x += s.vx;
          s.y += s.vy;
          
          if (s.x < 0 || s.x > canvas.width) s.vx *= -1;
          if (s.y < 0 || s.y > canvas.height) s.vy *= -1;
          
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
          ctx.fill();
        });
        
        requestAnimationFrame(animateStars);
      }
      
      animateStars();
      
      // Console tests
      console.table({
        'Clocks': offices.length,
        'Status items': categories.flatMap(c => c.systems).length,
        'Systems': categories.flatMap(c => c.systems).length,
        '7d bars': 7,
        '30d bars': 30,
        '90d bars': 90,
        'Language': currentLang
      });
      
      console.log('✅ Status Page initialized');
      if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/sw.js').catch(()=>{}); }
    }
    
    // Run on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
    
    // Pause animations on tab hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopLive();
      } else if (isLive) {
        startLive();
      }
    });
    
    // Respect prefers-reduced-motion
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      document.querySelectorAll('.ticker-content').forEach(t => {
        t.style.animation = 'none';
      });
    }
  </script>
</body>
</html>